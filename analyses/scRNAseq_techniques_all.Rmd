---
title: "progeny_dorothea_downsampling"
author: "Christian Holland"
date: "24/09/2018"
output: html_document
---
```{r "knitr config", cache=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::knit(..., quiet = TRUE)
```

### Libraries and sources
These libraries and sources are used in this analysis 
```{r "setup", message=F}
library(scran)
library(tidyverse)
library(tidylog)
library(cowplot)
library(myutils)
library(furrr)
library(pheatmap)
library(AUCell)
library(Rtsne)
library(cluster)
library(Matrix)
library(umap)
library(reticulate)
library(furrr)
library(viper)
library(scMerge)

plan(multiprocess)
options("tidylog.display" = list(print))

source("src/my_ggplot_themes.R")
```

```{r "load data and translate gene ids"}
df = list.files("data/scRNAseq_techniques/expression_data", full.names = T) %>%
  map_df(function(path) {
    technology = basename(path) %>%
      strsplit("[.]") %>%
      pluck(1,1)
    dat = get(load(path))
    dat$UMI$downsampled_20000 %>%
      rownames_to_column("gene") %>%
      gather(cell, count, -gene) %>%
      filter(count != 0) %>%
      as_tibble() %>%
      mutate(technology = technology)
  })

gene_annotation = read_csv("data/annotations/hgnc_ensembl_entrez.csv") %>%
  distinct(hgnc_symbol, gene = ensembl_gene_id_version) %>%
  drop_na()

count_mat = df %>%
  inner_join(gene_annotation, by="gene") %>%
  select(cell, gene = hgnc_symbol, count, technology) %>%
  mutate(cell = str_replace(cell, "[.]", "_"))

saveRDS(count_mat, "output/scRNAseq_techniques/counts_all_technologies.rds")
```
### Data pre-processing
```{r "pre-process data"}
sce = get(load("data/scRNAseq_techniques/expression_data/sce.all.technologies.RData"))

emat = assay(sce) %>%
  data.frame(check.names = F, stringsAsFactors = F) %>%

meta = colData(sce) %>%
  data.frame(check.names = F, stringsAsFactors = F) %>%
  rownames_to_column("cell") %>%
  as_tibble() %>%
  dplyr::rename(technology = batch) %>%
  mutate(technology = as_factor(technology))

expr = meta %>% 
  separate(cell, into = c("id"), remove = F) %>%
  distinct(id, technology) %>%
  select(technology, id) %>%
  nest(-technology, .key="id") %>%
  transmute(technology, emat = id %>% map(function(i) {
    emat %>% 
      select(contains(pull(i, id))) %>%
      as.matrix() %>%
      Matrix(sparse=T)
  }))

saveRDS(expr, "output/scRNAseq_techniques/expression_all_13_technologies.rds")
saveRDS(meta, "output/scRNAseq_techniques/meta_df.rds")
```

### Exploraroty analysis
#### Library sizes
```{r "library sizes"}
count_mat = readRDS("output/scRNAseq_techniques/expression_all_13_technologies.rds")
df = count_mat %>%
  transmute(technology, x = emat %>% map(function(emat) {
    emat %>% 
      as.matrix() %>% 
      colSums() %>% 
      enframe("cell", "libsize")
  }))

num_cells = df %>% 
  unnest() %>% 
  dplyr::count(technology)

df %>% 
  unnest() %>%
  ggplot(aes(x=fct_reorder(technology, libsize, .fun = median), y=libsize, color=technology)) +
  geom_boxplot() +
  geom_text(data = num_cells, aes(x=technology, y = 20000, label = n)) +
  labs(x="Technology", y= "Library size") +
  theme(legend.position = "none") +
  my_theme() +
  coord_flip()
```

#### Numbers of different celltype per technology
```{r "numbers of different celltype per technology"}
meta = readRDS("output/scRNAseq_techniques/meta_df.rds")

meta %>%
  dplyr::count(technology, nnet2) %>%
  ggplot(aes(x=nnet2, y=log2(n), fill=nnet2)) +
  geom_col() +
  coord_flip() +
  facet_wrap(~technology, scales="free") +
  theme(legend.position = "none") +
  my_theme() +
  geom_hline(yintercept = log2(50)) +
  labs(y = "log2(count)", x="Celltype")
```
#### Gene coverage per technology
```{r "gene coverage per technology"}
count_mat = readRDS("output/scRNAseq_techniques/expression_all_13_technologies.rds")
emat = count_mat[1,2] %>% pluck(1,1)
df = count_mat %>%
  transmute(technology, x = emat %>% map(function(emat) {
    emat %>% 
      summary() %>%
      as_tibble() %>%
      dplyr::rename(cell=j) %>%
      dplyr::count(cell)
  }))

num_cells = df %>% 
  unnest() %>%
  distinct(technology, cell) %>%
  dplyr::count(technology)

df %>%
  unnest(x) %>%
  ggplot(aes(x=fct_reorder(technology, n, .fun=median), y=n, color=technology)) +
  geom_boxplot() +
  geom_text(data = num_cells, aes(x=technology, y = 7000, label = n)) +
  labs(x = "Technology", y="Number of non-zero genes") +
  my_theme() +
  theme(legend.position = "none") +
  coord_flip()
```

#### Relationship between number of non-zero genes and number of cells
```{r "relationship between number of non-zero genes and number of cells}
count_mat = readRDS("output/scRNAseq_techniques/expression_all_13_technologies.rds")
df = count_mat %>%
  transmute(technology, x = emat %>% map(function(emat) {
    emat %>% 
      summary() %>%
      as_tibble() %>%
      dplyr::rename(cell=j) %>%
      dplyr::count(cell, name = "num_non_zero_genes") %>%
      add_tally(name = "num_cells") %>%
      select(-cell)
  }))

df %>%
  unnest() %>%
  group_by(technology) %>%
  summarise(num_non_zero_genes = mean(num_non_zero_genes),
            num_cells = mean(num_cells)) %>%
  ggplot(aes(x=num_cells, y=num_non_zero_genes)) +
  geom_point() +
  geom_smooth(method="lm") +
  my_theme()
```

#### Summary Exploratory analysis
```{r "Exploratory analysis"}
plot_grid(plot_grid(lib_size, non_zero_genes, labels="AUTO"), num_cell_types, labels=c("", "C"), ncol=1)
```
### Normalization
#### Individual normalization with srcan
```{r "Individual normalization with scran}
count_mat = readRDS("output/scRNAseq_techniques/expression_all_13_technologies.rds")

expr_norm = count_mat %>%
  transmute(technology, norm = emat %>% map(function(emat) {
    SingleCellExperiment(list(counts=emat)) %>%
      computeSumFactors() %>%
      normalize() %>%
      exprs()
  }))

saveRDS(expr_norm, "output/scRNAseq_techniques/norm_expression_all_13_technologies.rds")
```

#### Normlization across all technologies
```{r "normlization across all technologies}
count_mat = readRDS("output/scRNAseq_techniques/expression_all_13_technologies.rds")

emat = count_mat %>% 
  pull(emat) %>%
  purrr::reduce(cbind)
```

### Run Footprint methods
#### Run PROGENy
```{r "run progeny"}
expr_norm = readRDS("output/scRNAseq_techniques/norm_expression_all_13_technologies.rds")
M = progeny_matrix_human_v1 %>%
  spread(pathway, weight, fill=0) %>%
  data.frame(row.names = 1, check.names = F, stringsAsFactors = F)

sc_progeny = function(expr, M, ...) {
  common_genes = intersect(rownames(expr), rownames(M))
  expr_matched = expr[common_genes,,drop=FALSE] %>%
    t()
  M_matched = M[common_genes,, drop=FALSE] %>%
    data.matrix()
  
  stopifnot(names(expr_matched) == rownames(M_matched))
  
  scores = expr_matched %*% M_matched
  res = scale(scores)
  return(res)
}

progeny_scores = expr_norm %>%
  transmute(technology, progeny = norm %>% map(sc_progeny, M=M))

saveRDS(progeny_scores, "output/scRNAseq_techniques/progeny_scores_all_13_technologies.rds")
```

#### Run PROGENy with full matrix
```{r "run progeny with full matrix"}
expr = readRDS("output/scRNAseq_techniques/expression_all_technologies.rds")
progeny_matrix = readRDS("data/full_progeny_matrix/full_progeny_matrix.rds") %>%
  select(gene, pathway, weight=zscore)
cell_annotation = readRDS("output/scRNAseq_techniques/cell_annotations.rds")


progeny_scores = expr %>%
  run_progeny(progeny_matrix, id_name = "cell", permutation = 0) %>%
  group_by(pathway, technology) %>%
  mutate(scaled_activity = scale(activity)) %>%
  ungroup() %>%
  full_join(cell_annotation)

saveRDS(progeny_scores, "output/scRNAseq_techniques/progeny_scores_full_matrix_all_technologies.rds")
```
#### Run PROGENy as viper regulon
```{r "run progeny as viper regulon"}
expr = readRDS("output/scRNAseq_techniques/expression_all_technologies.rds") %>%
  filter(technology == "QUARTZseq")
progeny_regulon = progeny_matrix_human_v1 %>%
  mutate(mor = sign(weight),
         likelihood = 1) %>%
  rename(tf = pathway, target = gene) %>%
  select(-weight)

viper_scores = expr %>%
  run_viper(progeny_regulon, id_name = "cell")

saveRDS(viper_scores, "output/scRNAseq_techniques/progeny_scores_regulon_QUARTZseq.rds")
```
#### Run VIPER
```{r "run viper"}
expr_norm = readRDS("output/scRNAseq_techniques/norm_expression_all_13_technologies.rds")
regulon = dorothea_regulon_human_v1 %>%
  filter(confidence %in% c("A","B")) %>%
  df2regulon()

sc_viper = function(expr, regulon, ...) {
  res = viper(eset = as.matrix(expr), regulon = regulon, nes = T, method = "scale",
              minsize = 4, eset.filter = F)
  return(res)
}

viper_scores = expr_norm %>%
  transmute(technology, viper = norm %>% future_map(sc_viper, regulon=regulon, .progress = T))

saveRDS(viper_scores, "output/scRNAseq_techniques/viper_scores_all_13_technologies.rds")
```

#### RUN AUCell
```{r "run aucell"}
count_mat = readRDS("output/scRNAseq_techniques/counts_all_technologies.rds")

counts = count_mat %>%
  filter(technology == "QUARTZseq") %>%
  select(cell, gene, count) %>%
  spread(cell, count, fill = 0) %>%
  column_to_rownames("gene") %>%
  as.matrix()

tf_conf_annotation = dorothea_regulon_human_v1 %>%
  distinct(tf, confidence)

regulons = dorothea_regulon_human_v1 %>%
  add_count(tf) %>%
  filter(n >= 4) %>%
  select(tf, target) %>%
  group_by(tf) %>%
  summarise(target = list(target)) %>%
  ungroup() %>%
  deframe()

rankings = AUCell_buildRankings(counts)
cells_auc = AUCell_calcAUC(regulons, rankings)
aucell_scores = AUCell_exploreThresholds(cells_auc, plotHist = F, assignCells = T) %>%
  getAssignments() %>%
  enframe("tf", "cell") %>%
  unnest(cell) %>%
  mutate(activity = 1)

aucell_scores %>%
  inner_join(tf_conf_annotation) %>%
  mutate(technology = "QUARTZseq") %>%
  saveRDS("output/scRNAseq_techniques/aucell_scores_QUARTZseq.rds")

getAUC(cells_auc) %>% 
  as.data.frame() %>% 
  rownames_to_column("tf") %>% 
  as_tibble() %>%
  gather(cell, auc, -tf) %>%
  saveRDS("output/scRNAseq_techniques/aucell_AUC_scores_QUARTZseq.rds")

```

### Clustering
#### UMAP & Silhouettes
```{r "umap & silhouettes"}
meta = readRDS("output/scRNAseq_techniques/meta_df.rds") %>%
  add_count(technology, nnet2) %>%
  filter(n >= 50) %>%
  select(-n) %>%
  nest(-technology, .key="meta")

norm_expr = readRDS("output/scRNAseq_techniques/norm_expression_all_13_technologies.rds") %>%
  mutate(class = "normalized_expression") %>%
  rename(mat = norm)

progeny100 = readRDS("output/scRNAseq_techniques/progeny_scores_all_13_technologies.rds") %>%
  mutate(class = "progeny100") %>%
  rename(mat = progeny)

viperAB = readRDS("output/scRNAseq_techniques/viper_scores_all_13_technologies.rds") %>%
  mutate(class = "viperAB") %>%
  rename(mat=viper)

raw_data = readRDS("output/scRNAseq_techniques/expression_all_13_technologies.rds") %>%
  mutate(class = "raw_expression") %>%
  rename(mat = emat)

df = bind_rows(norm_expr, progeny100, raw_data, viperAB) %>%
  left_join(meta)

mat = df[1,2] %>% pluck(1,1)
meta = df[1,4] %>% pluck(1,1)
coords = res[1,3] %>% pluck(1,1)

res = df %>%
  transmute(technology, class, coords = pmap(., .f=do_umap)) %>%
  mutate(sil = pmap(., .f=do_sil))

saveRDS(res, "output/scRNAseq_techniques/cluster_results.rds")

do_umap = function(mat, meta, class, technology,...) {
  message(technology, " - ", class)
  if (class == "progeny100") {
    mat = t(mat)
  }
  cells = meta %>% pull(cell)
  stopifnot(colnames(mat[,cells]) == meta$cell)
  
  mat[,cells] %>%
    as.matrix() %>%
    t() %>%
    umap(method="umap-learn") %>%
    pluck("layout") %>%
    data.frame(check.names = F, stringsAsFactors = F) %>%
    rownames_to_column("cell") %>%
    as_tibble() %>%
    left_join(meta, by="cell")
}
do_sil = function(coords, ...) {
  cluster_vec = coords %>%
      distinct(cell, nnet2) %>%
      mutate(celltype = as_factor(nnet2),
             cluster_celltype_id = as.integer(celltype))

  meta_cluster = cluster_vec %>%
    distinct(celltype, cluster_celltype_id) %>%
    mutate_if(is.integer, as.character)
    
  stopifnot(coords$cell == cluster_vec$cell)
  dist_mat = coords %>%
    select_if(is.numeric) %>%
    dist()
  
  s_celltype = silhouette(cluster_vec$cluster_celltype_id, dist_mat)
  summary_s_celltype = s_celltype %>% summary()
  
  
  summary_s_celltype %>%
      pluck("clus.avg.widths") %>%
      enframe("cluster_celltype_id", "avg_width") %>%
      left_join(meta_cluster) %>%
      distinct(celltype, avg_width) %>%
      mutate(mean_avg_width = pluck(summary_s_celltype, "avg.width"),
             size = as.vector(pluck(summary_s_celltype, "clus.sizes")),
             obj = list(s_celltype)) %>%
      mutate(cluster_ref = "celltype")
}
```

#### Cluster visualization
```{r "cluster visualization}
res = readRDS("output/scRNAseq_techniques/cluster_results.rds")
# mean average width per technology and class
res %>%
  unnest(sil) %>%
  distinct(technology, class, mean_avg_width) %>%
  ggplot(aes(x=fct_reorder(technology, mean_avg_width), y=mean_avg_width)) +
  geom_col() +
  facet_wrap(~class) +
  my_theme() +
  coord_flip()

# average width per celltype, technology and class
res %>%
  unnest(sil) %>%
  ggplot(aes(x=celltype, y=avg_width, fill=celltype)) +
  geom_col() +
  facet_wrap(~technology+class) +
  my_theme()

res %>% 
  unnest(sil) %>%
  #filter(celltype == "unclassified") %>%
  ggplot(aes(x=class, y=avg_width, fill=celltype)) +
  geom_hline(yintercept = 0, linetype="dashed") +
  geom_violin() +
  geom_jitter(height = 0, width = 0.1, alpha=.5) +
  facet_wrap(~celltype) +
  coord_flip() +
  my_theme()

# umap plots
res %>% 
  #filter(technology == "Smart-Seq2") %>%
  unnest(coords) %>%
  ggplot(aes(x=`1`, y=`2`, color=nnet2)) +
  geom_point() +
  theme(axis.text = element_blank(),
          axis.ticks = element_blank(),
          axis.line = element_blank(),
          axis.title = element_blank()) +
  my_theme() +
  scale_colour_discrete(drop=FALSE) +
  facet_grid(class~technology, scales="free")
```
#### Correlation of silhouette results with libsize and number of non-zero-genes
```{r "correlation of silhouette results with libsize and number of non-zero-genes}
res = readRDS("output/scRNAseq_techniques/cluster_results.rds") %>%
  unnest(sil) %>%
  filter(class == "progeny100") %>%
  distinct(technology, mean_avg_width)

count_mat = readRDS("output/scRNAseq_techniques/expression_all_13_technologies.rds")
emat = count_mat[1,2] %>% pluck(1,1)
non_zero_genes_df = count_mat %>%
  transmute(technology, median_non_zero_genes = emat %>% map(function(emat) {
    emat %>% 
      summary() %>%
      as_tibble() %>%
      dplyr::rename(cell=j) %>%
      dplyr::count(cell) %>%
      summarise(median_non_zero_genes = median(n),
                mean_non_zero_genes = mean(n))
  })) %>%
  unnest()

libsize_df = count_mat %>%
  transmute(technology, x = emat %>% map(function(emat) {
    emat %>% 
      as.matrix() %>% 
      colSums() %>% 
      enframe("cell", "libsize") %>%
      summarise(median_libsize = median(libsize),
                mean_libsize = mean(libsize))
  })) %>%
  unnest()

left_join(res, non_zero_genes_df) %>%
  left_join(libsize_df) %>%
  # ggplot(aes(x=mean_non_zero_genes, y=mean_avg_width)) +
  ggplot(aes(x=mean_libsize, y=mean_avg_width)) +
  geom_point() +
  geom_smooth(method="lm") +
  my_theme()
```

### PROGENy/DoRothEA
#### Pathway activity overview
```{r "pathway activity overview"}
progeny_scores = readRDS("output/scRNAseq_techniques/progeny_scores_all_technologies.rds") %>%
  mutate(group = "progeny100")

progeny_scores %>%
  drop_na(celltype) %>%
  filter_celltypes(min_num_cells = 50) %>%
  #filter(pathway %in% c("Androgen", "EGFR")) %>%
  ggplot(aes(x=technology, y=scaled_activity, color=technology)) +
  geom_hline(yintercept = 0, color="gray") +
  geom_violin() +
  facet_grid(celltype~pathway) +
  my_theme() +
  labs(x = "scRNA-seq technology", y = "Pathway activity") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

# focus on immune related pathways
progeny_scores %>%
  drop_na(celltype) %>%
  filter_celltypes(min_num_cells = 50) %>%
  filter(pathway %in% c("JAK-STAT", "NFkB", "TNFa", "TGFb")) %>%
  ggplot(aes(x=technology, y=scaled_activity, color=technology)) +
  geom_hline(yintercept = 0, color="gray") +
  geom_violin() +
  facet_grid(celltype~pathway) +
  my_theme() +
  labs(x = "scRNA-seq technology", y = "Pathway activity") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
  
res = progeny_scores %>% mutate(technology = as_factor(technology)) %>%
  filter_celltypes(min_num_cells = 50) %>%
  filter(celltype != "unclassified") %>%
  group_by(pathway, celltype) %>%
  mutate(anova = list(broom::tidy(aov(activity ~ technology)))) %>%
  ungroup() %>%
  unnest(anova) %>%
  filter(term == "technology") %>%
  distinct(celltype, pathway, term, df, sumsq, meansq, statistic, p.value) %>%
  mutate(adj.p.value = p.adjust(p.value))

res %>%
  ggplot(aes(x=celltype, y=-log10(adj.p.value))) +
  geom_col() +
  facet_wrap(~pathway) +
  coord_flip() +
  geom_hline(yintercept = -log10(0.05), color="red")  
```

#### TF activity overview
```{r "tf activity overview"}
viper_scores = readRDS("output/scRNAseq_techniques/viper_scores_all_technologies.rds") %>%
  mutate(group = "viper")

viper_scores %>%
  inner_join(x) %>%
  drop_na(celltype) %>%
  filter_celltypes(min_num_cells = 50) %>%
  #filter(pathway %in% c("Androgen", "EGFR")) %>%
  ggplot(aes(x=technology, y=activity, color=technology)) +
  geom_hline(yintercept = 0, color="gray") +
  geom_violin() +
  facet_wrap(~celltype+tf) +
  my_theme() +
  labs(x = "scRNA-seq technology", y = "TF activity") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

# focus on immune related pathways
viper_scores %>%
  drop_na(celltype) %>%
  filter_celltypes(min_num_cells = 50) %>%
  filter(tf %in% c("NFKB1", "NFKB2", "SMAD1", "SMAD2", "STAT1", "STAT2")) %>%
  ggplot(aes(x=technology, y=activity, color=technology)) +
  geom_hline(yintercept = 0, color="gray") +
  geom_violin() +
  facet_grid(celltype~tf) +
  my_theme() +
  labs(x = "scRNA-seq technology", y = "TF activity") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
  
res_viper = viper_scores %>%
  filter(confidence %in% c("A", "B", "C")) %>%
  filter_celltypes(min_num_cells = 50) %>%
  mutate(technology = as_factor(technology)) %>%
  filter(celltype != "unclassified") %>%
  group_by(tf, celltype) %>%
  mutate(anova = list(broom::tidy(aov(activity ~ technology)))) %>%
  ungroup() %>%
  unnest(anova) %>%
  filter(term == "technology") %>%
  distinct(celltype, tf, term, df, sumsq, meansq, statistic, p.value) %>%
  mutate(adj.p.value = p.adjust(p.value))

x = res_viper %>% filter(adj.p.value > 0.05) %>%
  distinct(celltype, tf)

res %>%
  ggplot(aes(x=celltype, y=-log10(adj.p.value))) +
  geom_col() +
  facet_wrap(~pathway) +
  coord_flip() +
  geom_hline(yintercept = -log10(0.05), color="red")  
```

#### Silhouettes
```{r "silhouettes"}
cell_annotation = readRDS("output/scRNAseq_techniques/cell_annotations.rds")
progeny_scores = readRDS("output/scRNAseq_techniques/progeny_scores_all_technologies.rds") %>%
  mutate(group = "progeny100") %>%
  select(-activity) %>%
  rename(feature = pathway, value = scaled_activity) %>%
  drop_na(celltype)
expr_scores = readRDS("output/scRNAseq_techniques/expression_all_technologies.rds") %>%
  inner_join(cell_annotation, by=c("cell", "technology")) %>%
  mutate(group = "expression") %>%
  rename(feature = gene, value = expression) %>%
  drop_na(celltype)



df_sil = bind_rows(progeny_scores, expr_scores) %>%
  #filter(group == "expression" & technology == "CELseq2") %>%
  filter_celltypes(min_num_cells = 50) %>%
  nest(-c(technology, group), .key="tidy_df") %>%
  filter(group == "progeny100") %>%
  mutate(mat = tidy_df %>% map(~spread(., feature, value, fill=0)),
         sil_obj = mat %>% map(~do_silhouette(.)),
         avg_width = sil_obj %>% map(function(obj) {
           obj %>% summary() %>% pluck("avg.width")
         }))
```
#### t-SNE
```{r "t-sne"}
cell_annotation = readRDS("output/scRNAseq_techniques/cell_annotations.rds")
progeny_scores = readRDS("output/scRNAseq_techniques/progeny_scores_all_technologies.rds") %>%
  mutate(group = "progeny_100") %>%
  select(-activity) %>%
  rename(feature = pathway, value = scaled_activity) %>%
  drop_na(celltype)

progeny_scores_full = readRDS("output/scRNAseq_techniques/progeny_scores_full_matrix_all_technologies.rds") %>%
  mutate(group = "progeny_all") %>%
  select(-activity) %>%
  rename(feature = pathway, value = scaled_activity) %>%
  drop_na(celltype)

expr_scores = readRDS("output/scRNAseq_techniques/expression_all_technologies.rds") %>%
  inner_join(cell_annotation, by=c("cell", "technology")) %>%
  mutate(group = "expression") %>%
  rename(feature = gene, value = expression) %>%
  drop_na(celltype)

viper_scores = readRDS("output/scRNAseq_techniques/viper_scores_all_technologies.rds") %>%
  filter(confidence %in% c("A", "B", "C")) %>%
  mutate(group = "viper_ABC") %>%
  select(-confidence) %>%
  rename(feature = tf, value = activity) %>%
  drop_na(celltype)

tf_expression = expr_scores %>%
  inner_join(distinct(viper_scores, feature), by="feature") %>%
  mutate(group = "tf_expression")

footprint_expression = expr_scores %>%
  inner_join(distinct(rename(progeny_matrix_human_v1, feature = gene), feature), by="feature") %>%
  mutate(group = "footprint_expression")

# it would be interesting to explore whether the combinations of PROGENy and DoRothEA show superior power than the individual matrices
footprint_scores = bind_rows(mutate(progeny_scores, group = "footprints"),
                             mutate(viper_scores, group = "footprints"))

df = #bind_rows(progeny_scores, progeny_scores_full, viper_scores, tf_expression, expr_scores, footprint_expression) %>%
  footprint_scores %>%
  #filter(group == "footprint_expression") %>%
  filter(technology != "MARSseq") %>%
  filter_celltypes(min_num_cells = 50) %>%
  nest(-c(technology, group), .key="tidy_df") %>%
  mutate(mat = tidy_df %>% map(~spread(., feature, value, fill=0))) %>%
  mutate(tsne = pmap(., .f = do_tsne),
         pca = pmap(., .f = do_pca)) %>%
  mutate(sil_obj = pmap(., .f=do_silhouette),
         avg_width = sil_obj %>% map(function(obj) {
           obj %>% summary() %>% pluck("avg.width")
         }))
df %>%
  saveRDS(file="output/scRNAseq_techniques/tsne_pca_sil.rds")
df %>%
  saveRDS(file = "output/scRNAseq_techniques/tsne_pca_sil_footprints.rds")

df = readRDS("output/scRNAseq_techniques/tsne_pca_sil.rds")



#############
# plot list
tsne_plots = df %>%
  select(technology, group, tsne, pca) %>%
  gather(tool, fig, tsne, pca) %>%
  filter(tool == "tsne") %>%
  arrange(technology) %>%
  pull(fig) %>%
  map(function(p) {
    p + theme(legend.position = "none")
  })

pca_plots = df %>%
  select(technology, group, tsne, pca) %>%
  gather(tool, fig, tsne, pca) %>%
  filter(tool == "pca") %>%
  arrange(technology) %>%
  pull(fig) %>%
  map(function(p) {
    p + theme(legend.position = "none")
  })

plot_grid(plotlist = tsne_plots, ncol=6)
plot_grid(plotlist = pca_plots, ncol=6)

# avg sil
df %>%
  select(technology, group, avg_width) %>%
  unnest(avg_width) %>%
  ggplot(aes(x = group, y=avg_width, fill=technology)) +
  geom_col() +
  facet_grid(~technology) +
  labs(y = "Average silhouette width", x = "Group") +
  coord_flip() +
  geom_hline(yintercept = 0, linetype="dashed")

```

```{r "plots for slides"}
df = readRDS("output/scRNAseq_techniques/tsne_pca_sil.rds")
df_footprints = readRDS("output/scRNAseq_techniques/tsne_pca_sil_footprints.rds")

d = bind_rows(df, df_footprints)
tsne_plots = d %>%
  #filter(technology %in% c("QUARTZseq", "SCRBseq")) %>%
  select(technology, group, tsne, pca) %>%
  gather(tool, fig, tsne, pca) %>%
  filter(tool == "tsne") %>%
  arrange(technology) %>%
  pull(fig) %>%
  map(function(p) {
    p + theme(legend.position = "none")
  })

plot_grid(plotlist = tsne_plots, ncol=7)
# get cell type legend
p = df[1,5] %>% pull() %>% pluck(1)
leg = get_legend(p + theme(legend.position = "bottom"))
plot_grid(leg)
```
### Utils functions
```{r "utils"}
filter_celltypes = function(df, min_num_cells = 50) {
  res = df %>%
    distinct(technology, cell, celltype, group) %>%
    count(technology, group, celltype) %>%
    filter(n >= min_num_cells) %>%
    select(technology, celltype, group) %>%
    inner_join(df, by=c("technology", "celltype", "group"))
  
  return(res)
}

do_silhouette = function(mat, technology=NULL, group=NULL, ...) {
  message("Silhouette:", group, "-", technology)
  cluster_vec = mat %>%
    select(celltype, cell) %>%
    mutate(cluster_id = as.integer(celltype))
  
  stopifnot(cluster_vec$cell == mat$cell)
  dist_mat = mat %>% 
    select_if(is.numeric) %>%
    data.matrix() %>%
    dist()
  
  silhouette(cluster_vec$cluster_id, dist_mat)
}

do_tsne = function(mat, technology, group, ...) {
  message("tSNE:", group, "-", technology)
  set.seed(321)
  tsne_object = mat %>%
    select_if(is.numeric) %>%
    distinct() %>%
    as.matrix() %>%
    Rtsne()
  
  coords = tsne_object %>%
    pluck("Y") %>%
    as_tibble() %>%
    mutate(celltype = mat$celltype)
  

  p = ggplot(coords, aes(x=V1, y=V2, color=celltype)) +
    geom_point() +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank(),
          axis.line = element_blank(),
          axis.title = element_blank()) +
    my_theme() +
    scale_colour_discrete(drop=FALSE) +
    ggtitle(paste0(group,"-", technology))
  
  return(p)
}

do_pca = function(mat, technology, group, ...) {
  message("PCA:", group, "-", technology)
  pca_object = mat %>%
    select_if(is.numeric) %>%
    prcomp(center=T, scale. = T)
  
  explained = round((pca_object$sdev)^2 / sum(pca_object$sdev^2),4) * 100
  
  coords = pca_object$x %>%
    as_tibble() %>%
    mutate(celltype = mat$celltype)
          
  
  p = ggplot(coords, aes(x=PC1, y=PC2, color=celltype)) +
    geom_point() +
    labs(x = paste0("PC1 (", explained[1], "%)"),
         y = paste0("PC2 (", explained[2], "%)")) +
    my_theme() +
    scale_colour_discrete(drop=FALSE) +
    ggtitle(paste0(group,"-", technology))

  
}
```

### Viper vs AUCell
```{r "viper vs aucell"}
a = readRDS("output/scRNAseq_techniques/aucell_AUC_scores_QUARTZseq.rds") %>%
  rename(aucell = auc)
v = readRDS("output/scRNAseq_techniques/viper_scores_QUARTZseq.rds") %>%
  select(tf, cell, viper = activity)

df = inner_join(a,v, by = c("tf", "cell"))
cor_df = df %>%
  nest(-tf) %>%
  mutate(r = data %>% map(~tidy(cor.test(.$aucell, .$viper)))) %>%
  select(-data) %>%
  unnest(r) %>%
  select(tf, r = estimate, p.value)

# p-value histogramm
cor_df %>%
  ggplot(aes(x=p.value)) +
  geom_histogram(bins=20, boundary = 0) +
  my_theme()

# correlation coefficient histogramm
cor_df %>%
  ggplot(aes(x=r)) +
  geom_histogram(bins=40, boundary = -1) +
  my_theme()

cor_df %>% 
  ntile(x=r, n=3)

df %>%
  filter(tf %in% c("SNAI3", "TFEC", "ZNF74")) %>%
  ggplot(aes(x=aucell, y=viper)) +
  geom_point() +
  facet_wrap(~tf) +
  my_theme() +
  geom_smooth(method = "lm")
```
### All technologies
```{r "all technologies}
sce = get(load("data/scRNAseq_techniques/expression_data/sce.all.technologies.RData"))

emat = assay(sce) %>%
  data.frame(check.names = F, stringsAsFactors = F) %>%

meta = colData(sce) %>%
  data.frame(check.names = F, stringsAsFactors = F) %>%
  rownames_to_column("cell") %>%
  as_tibble() %>%
  dplyr::rename(technology = batch) %>%
  mutate(technology = as_factor(technology))

expr = meta %>% 
  separate(cell, into = c("id"), remove = F) %>%
  distinct(id, technology) %>%
  select(technology, id) %>%
  nest(-technology, .key="id") %>%
  transmute(technology, emat = id %>% map(function(i) {
    emat %>% 
      select(contains(pull(i, id))) %>%
      as.matrix() %>%
      Matrix(sparse=T)
  }))

saveRDS(expr, "output/scRNAseq_techniques/expression_all_13_technologies.rds")
saveRDS(meta, "output/scRNAseq_techniques/meta_df.rds")
```